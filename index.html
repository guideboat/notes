<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Notes Chat â€“ Sign in</title>
    <style>
      body { font-family: system-ui, sans-serif; margin: 2rem; }
      .card { max-width: 520px; padding: 1.25rem; border: 1px solid #ddd; border-radius: 12px; }
      input, button { font: inherit; padding: .6rem .8rem; margin-top: .5rem; width: 100%; }
      .row { display: grid; gap: .75rem; }
      #chat { margin-top: 2rem; }
      .muted { color: #666; font-size: .9rem; }
    </style>
    <script type="module">
      import { createClient } from 'https://esm.sh/@supabase/supabase-js';
      import { createChat }   from 'https://esm.sh/@n8n/chat';

      // -------------- CONFIG --------------
      const SUPABASE_URL       = 'https://opfsnfqakcyaubxfemhp.supabase.co';
      const SUPABASE_ANON_KEY  = 'sb_publishable_nL82jlMzjLIZb11001HFtQ_VMr9KV3d';
      const N8N_CHAT_WEBHOOK   = 'https://hogueinstitute.app.n8n.cloud/webhook/c361deb0-4745-4ac0-8542-afdcbeb75799/chat
';
      // ------------------------------------

      const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
        auth: {
          persistSession: true,           // store in localStorage automatically
          autoRefreshToken: true,         // keep session fresh in browser
          detectSessionInUrl: false       // no redirect flow needed for password login
        }
      });

      async function startChat(session) {
        const { access_token, refresh_token, user } = session;
        // Show widget container
        document.querySelector('#login-card').style.display = 'none';
        document.querySelector('#chat').style.display = 'block';

        // Launch n8n chat and pass Supabase tokens as metadata
        createChat({
          webhookUrl: N8N_CHAT_WEBHOOK,
          // You can customize the widget UI; this keeps defaults
          metadata: {
            supabaseAccessToken:  access_token,
            supabaseRefreshToken: refresh_token,
            supabaseUserId:       user?.id || null,
            // Optional: pass profile or display info if you keep it in your DB
          }
        });
      }

      // On page load: if already signed in, jump straight to chat
      supabase.auth.getSession().then(({ data: { session } }) => {
        if (session?.access_token) startChat(session);
      });

      // Login form
      window.handleLogin = async (e) => {
        e.preventDefault();
        const email = document.querySelector('#email').value.trim();
        const pass  = document.querySelector('#pass').value;
        const out   = document.querySelector('#out');
        out.textContent = 'Signing in...';

        const { data, error } = await supabase.auth.signInWithPassword({ email, password: pass });
        if (error) {
          out.textContent = 'Error: ' + (error.message || 'Login failed');
          return;
        }
        out.textContent = 'Signed in.';
        await startChat(data.session);
      };

      // Optional: Sign up (you can hide or keep)
      window.handleSignup = async (e) => {
        e.preventDefault();
        const email = document.querySelector('#email').value.trim();
        const pass  = document.querySelector('#pass').value;
        const out   = document.querySelector('#out');
        out.textContent = 'Creating account...';
        const { data, error } = await supabase.auth.signUp({ email, password: pass });
        if (error) { out.textContent = 'Error: ' + error.message; return; }
        out.textContent = 'Account created. Check your email if confirmation is required, then sign in.';
      };

      // Optional: Sign out
      window.handleSignout = async () => {
        await supabase.auth.signOut();
        location.reload();
      };
    </script>
  </head>
  <body>
    <div id="login-card" class="card">
      <h1>Notes Chat</h1>
      <p class="muted">Sign in with your Supabase email + password to chat.</p>
      <form class="row" onsubmit="handleLogin(event)">
        <input id="email" type="email" placeholder="you@example.com" required />
        <input id="pass"  type="password" placeholder="password" required />
        <button type="submit">Sign in</button>
        <button onclick="handleSignup(event)">Create account</button>
      </form>
      <p id="out" class="muted"></p>
    </div>

    <div id="chat" style="display:none;">
      <button onclick="handleSignout()">Sign out</button>
      <!-- The n8n widget will inject itself in-page -->
    </div>
  </body>
</html>
